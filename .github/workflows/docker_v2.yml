name: Docker CI/CD v2

on:
  push:
    branches:
      - feature-jm-sysadm #main
      #- '**'
jobs:
    DockerBuild:
        runs-on: ubuntu-latest
        steps:

        - name: Checkout code
          uses: actions/checkout@v4
          with:
              fetch-depth: 0

        - name: Docker Login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USER }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        
        # - name: Setup Testcontainers Cloud Client
        #   uses: atomicjar/testcontainers-cloud-setup-action@main
        #   with:
        #     token: ${{ secrets.TC_CLOUD_TOKEN }}

        - name: Docker Build
          run: |
            docker build -t jmsysadm/nodejs .
    
        - name: Push Docker
          run: |
            docker push jmsysadm/nodejs

    DockerScan:
        needs: DockerBuild
        runs-on: ubuntu-latest
        steps:

        - name: Checkout code
          uses: actions/checkout@v4
          with:
              fetch-depth: 0
          
        - name: Docker Login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USER }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        
        - name: Pull Docker
          run: |
            docker pull jmsysadm/nodejs

        # - name: Run Trivy vulnerability scanner - Format table view
        #   uses: aquasecurity/trivy-action@master
        #   with:
        #     image-ref: 'jmsysadm/nodejs'
        #     format: 'table'

        - name: Run Trivy vulnerability scanner - Generate SARIF Report
          uses: aquasecurity/trivy-action@master
          id: TrivyScanReport
          with:
            scan-type: "image"
            format: 'table'
            image-ref: 'jmsysadm/nodejs'
            #output: 'trivy-results.sarif'
            severity: HIGH,CRITICAL
            ignore-unfixed: true
            exit-code: 0 # 1

        - name: Validar UbicaciÃ³n de reporte
          run: |
            if [ -f "trivy-results.sarif" ]; then
              echo "Reporte trivy scan existente"
              echo "Activando full privilegios sobre el reporte"
              chmod 777 trivy-results.sarif
            else 
              echo "No se encuentra el reporte"
            fi

        # - name: Upload Test results
        #   uses: actions/upload-artifact@master
        #   with:
        #     name: TrivyScanReport
        #     path: ${{github.workspace}}/trivy-results.sarif
        
    deploy:
      name: Deploy Docker Image
      needs: DockerScan
      runs-on: self-hosted
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
              fetch-depth: 0

        - name: Docker Login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USER }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        
        - name: Run as Admin
          run: |
            whoami
            $myWindowsID=[System.Security.Principal.WindowsIdentity]::GetCurrent()
            echo "myWindowsID=$myWindowsID"
            $myWindowsPrincipal=new-object System.Security.Principal.WindowsPrincipal($myWindowsID)
            echo "myWindowsPrincipal=$myWindowsPrincipal"
            $adminRole=[System.Security.Principal.WindowsBuiltInRole]::Administrator
            New-Item -Path "$LocalTestDir\sysout.txt -ItemType File
            if ($myWindowsPrincipal.IsInRole($adminRole)) `
            { 
              echo "is admin"
              echo "Run Container"
              docker pull jmsysadm/nodejs
              stop lab4-jm-sysadm || true && docker rm lab4-jm-sysadm || true
              docker run -d --name lab4-jm-sysadm -p 3000:3000 jmsysadm/nodejs
            } `
            else { `
              echo "is not admin"; `
              $passThruArgs = '-NoProfile -ExecutionPolicy Bypass -command', '&', "$env:GITHUB_WORKSPACE\RunAsAdmin.ps1", $arg, '*>', "`"$LocalTestDir\sysout.txt`""; `
              Start-Process powershell -Wait -Verb RunAs -ArgumentList $passThruArgs; `
              Get-Content "$LocalTestDir\sysout.txt"; `
            }`
            
        # - name: Pull Docker
        #   run: |
        #     docker pull jmsysadm/nodejs

        # - name: Stop and remove existing container
        #   run: |
        #     stop lab4-jm-sysadm || true && docker rm lab4-jm-sysadm || true

        # - name: Run Docker container
        #   run: |
        #     docker run -d --name lab4-jm-sysadm -p 3000:3000 jmsysadm/nodejs
        
     
